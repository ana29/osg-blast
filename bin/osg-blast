#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var osgblast = require("../");

var config_path;
if (process.argv.length == 3) {
    config_path = process.argv[2];
} else {
    console.log("config.json path not specified.. using local directory");
    config_path = "config.json";
}
//console.log("using config path:"+config_path);
config_path = path.resolve(config_path);

if(!fs.existsSync(config_path)) {
    console.log("failed to find config:"+config_path);
    process.exit(2);
}

var config = require(config_path);

//set rundir if it's not set
if(!config.rundir) {
    var rundir = path.dirname(config_path);
    config.rundir = rundir;
}
//set user if it's not set
if(!config.user) {
    config.user = process.getuid();
}

config.opissue_log = "opissue.log";

//create pid
fs.writeFile(config.rundir+"/pid.txt", process.pid.toString());

process.on('uncaughtException', function(err) {
    console.log('osg-blast: Caught exception: ' + err);
    console.trace(err);
    fs.appendFile(config.opissue_log, "osg-blast: uncaughtException\n"+err);
});

var prev_status;
function status(status, message) {
    if(status == null) {
        status = prev_status;
    } 
    fs.writeFileSync(config.rundir+"/status.txt", status+"\n"+message+"\n");
    var d = new Date();
    console.log(status + " :: " + d.toString() + " :: " + message);
    prev_status = status;
}

osgblast.run(config, status).then(function() {
    console.log("workflow completed successfully");
    //process.exit(0);
}).fail(function(err) {
    console.log("workflow failed permanently");
    console.log(err);
    //process.exit(1);
}).catch(function(err) {
    console.log("workflow threw exception:"+err);
}).done();
